(()=>{const t="Private session",n=100,e={PRIVATE_SESSION_INDICATOR:"button.main-actionButtons-button",MAIN_MENU:"div.main-topBar-topbarContentRight > button.main-userWidget-box",MENU_ITEM_LABEL:"span",MENU_ITEM_BUTTON:"button[role='menuitemcheckbox'], button[role='menuitem']",MENU_ITEM_CHECKED:"svg",PROFILE_DROPDOWN_MENU:"ul.main-contextMenu-menu, [role='menu'], ul[role='menu']"},i="ps-persistent-item";let o=!1,r=null,s=!1,c=!1,a=0,u=!1,l=!1,f=!1,m=null;async function p(){for(let i=0;i<2;i++){const i=document.querySelectorAll(e.PRIVATE_SESSION_INDICATOR);for(const n of i)if(n.textContent.includes(t))return n;await new Promise((t=>setTimeout(t,n)))}return null}function d(){localStorage.setItem("private-session-persistent-mode",o.toString())}async function w(){const t=await p();return l=!!t,l}function b(){if(m&&(clearTimeout(m),m=null),document.querySelector(e.PROFILE_DROPDOWN_MENU)){const t=document.querySelector(e.MAIN_MENU);t&&(t.click(),m=setTimeout((()=>{document.querySelector(e.PROFILE_DROPDOWN_MENU)&&t.click(),m=null}),150))}}async function y(i=!0){if(c)return!1;const o=Date.now();if(o-a<500)return!1;try{if(await w())return!0;if(!i)return!1;if(c=!0,a=o,b(),await new Promise((t=>setTimeout(t,150))),!await async function(t){const e=await async function(t){for(let e=0;e<3;e++){{const n=document.querySelector(t);if(n)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return e?(e.click(),e):null}(e.MAIN_MENU))return c=!1,!1;await new Promise((t=>setTimeout(t,200)));const r=await async function(t){for(let i=0;i<3;i++){const i=document.querySelectorAll(e.MENU_ITEM_BUTTON);if(i.length>0)for(const n of i){const i=n.querySelector(e.MENU_ITEM_LABEL);if(i&&i.textContent.trim()===t)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return r?(await async function(t){return!!t.querySelector(e.MENU_ITEM_CHECKED)}(r)?l=!0:(r.click(),l=!0,await new Promise((t=>setTimeout(t,n)))),b(),c=!1,!0):(b(),c=!1,!1)}catch(t){return b(),c=!1,!1}}function x(){o=!0,d(),r||(r=()=>{u||(u=!0,setTimeout((async()=>{u=!1,!await w()&&o&&await y(!0)}),500))},window.addEventListener("focus",r))}function g(t){return`\n    <div class="toggle-switch" style="\n      position: relative;\n      width: 40px;\n      height: 20px;\n      background-color: ${t?"#1DB954":"#535353"};\n      border-radius: 10px;\n      transition: background-color 0.3s;\n    ">\n      <div class="toggle-slider" style="\n        position: absolute;\n        top: 2px;\n        left: ${t?"22px":"2px"};\n        width: 16px;\n        height: 16px;\n        background-color: white;\n        border-radius: 50%;\n        transition: left 0.3s;\n      "></div>\n    </div>\n  `}function h(t,n){const e=Array.from(t.querySelectorAll("span"));for(const t of e)if(t.textContent===n)return t.closest("button");return null}function v(n,e=0){const s=Array.from(n.querySelectorAll("span")).find((n=>n.textContent===t));if(!s)return e<10&&setTimeout((()=>v(n,e+1)),100),null;const c=s.closest("li");if(!c)return null;const a=document.createElement("li");a.id=i,a.className=c.className;const u=document.createElement("div");u.className="main-contextMenu-menuItemButton",u.style.cssText="display:flex;align-items:center;padding:8px 12px;cursor:pointer;justify-content:space-between;",u.setAttribute("role","menuitem");const l=document.createElement("span");l.textContent="Persistent Privacy";const f=document.createElement("span");return f.className="sidebar-checkbox",f.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",f.innerHTML=g(o),f.title=o?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode",u.appendChild(l),u.appendChild(f),u.addEventListener("mouseover",(()=>u.style.backgroundColor="rgba(255,255,255,0.1)")),u.addEventListener("mouseout",(()=>u.style.backgroundColor="transparent")),u.addEventListener("click",(()=>{o=!o,d(),o?x():(o=!1,d(),r&&(window.removeEventListener("focus",r),r=null)),f.innerHTML=g(o),f.title=o?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"})),a.appendChild(u),c.after(a),a}function k(n){if(!n)return;if(!h(n,t))return;let r=n.querySelector("#"+i);r?function(t){let n=t;if(!n){const t=document.querySelector(e.PROFILE_DROPDOWN_MENU);t&&(n=t.querySelector("#"+i))}if(n){const t=n.querySelector("button");if(t){let n=t.querySelector(".sidebar-checkbox");n||(n=document.createElement("span"),n.className="sidebar-checkbox",n.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",t.appendChild(n)),n.innerHTML=g(o),n.title=o?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"}}}(r):r=v(n),o&&r&&p().then((e=>{if(!e){const i=h(n,t);i&&!e&&i.click()}}))}(async r=>{for(;!r();)await new Promise((t=>setTimeout(t,n)));await async function(){!function(){const t=localStorage.getItem("private-session-persistent-mode");o="true"===t}(),new MutationObserver((n=>{let o=!1,r=!1,c=null;for(const t of n){if(!s&&t.addedNodes)for(const n of t.addedNodes)if(1===n.nodeType){const t=e.PROFILE_DROPDOWN_MENU.split(", ");let i=null;for(const e of t)if(i=n.matches?.(e.trim())?n:n.querySelector?.(e.trim()),i)break;if(i){o=!0,c=i;break}}if(s&&t.removedNodes)for(const n of t.removedNodes)if(1===n.nodeType){const t=e.PROFILE_DROPDOWN_MENU.split(", ");let o=!1;for(const e of t)if(n.matches?.(e.trim())){o=!0;break}const s=n.querySelector?.("#"+i);if(o||s){r=!0;break}}if(o||r)break}if(r&&(s=!1),o&&c&&!s){const n=Array.from(c.querySelectorAll("span")).find((n=>n.textContent===t)),e=Array.from(c.querySelectorAll("span")).some((t=>"Settings"===t.textContent));(n||e)&&n&&(k(c),s=!0,a=Date.now())}})).observe(document.body,{childList:!0,subtree:!0}),await w(),f=!0,o&&x(),await new Promise((t=>setTimeout(t,800))),l||await y(!0)}()})((()=>Spicetify&&Spicetify.Platform&&Spicetify.Platform.FeedbackAPI&&"complete"===document.readyState))})();