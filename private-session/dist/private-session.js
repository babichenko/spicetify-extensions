(()=>{const t="Private session",n=100,e={PRIVATE_SESSION_INDICATOR_CONTAINER:".Root__globalNav > div:last-child",MAIN_MENU:"button.main-userWidget-box, button[data-testid='user-widget-avatar'], .main-userWidget-box button, [data-testid='user-widget-dropdown'], button.main-avatar-button",MENU_ITEM_LABEL:"span",MENU_ITEM_BUTTON:"button[role='menuitemcheckbox'], button[role='menuitem']",MENU_ITEM_CHECKED:"svg",PROFILE_DROPDOWN_MENU:"ul.main-contextMenu-menu, [role='menu'], ul[role='menu']"},o="ps-persistent-item";let i=!1,r=null,u=!1,s=!1,c=0,a=!1,l=null;function f(t){const n=document.querySelectorAll(e.MENU_ITEM_BUTTON);if(0===n.length)return null;for(const e of n)if(d(e,t))return e;return null}function d(t,n){const o=t.querySelector(e.MENU_ITEM_LABEL);return o&&o.textContent.trim()===n}function m(){const n=document.querySelector(e.PRIVATE_SESSION_INDICATOR_CONTAINER);return n?function(n){const e=n.querySelectorAll("button, * button, * * button, * * * button");for(const n of e)if(n.textContent.includes(t))return n;return null}(n):null}function p(){localStorage.setItem("private-session-persistent-mode",i.toString())}async function w(){return!!await async function(){for(let t=0;t<2;t++){const t=m();if(t)return t;await new Promise((t=>setTimeout(t,n)))}return null}()}function b(){if(l&&(clearTimeout(l),l=null),document.querySelector(e.PROFILE_DROPDOWN_MENU)){const t=document.querySelector(e.MAIN_MENU);t&&(t.click(),l=setTimeout((()=>{document.querySelector(e.PROFILE_DROPDOWN_MENU)&&t.click(),l=null}),150))}}function y(){b(),s=!1}async function g(o=!0){if(s||Date.now()-c<500)return!1;try{return!!await w()||await async function(o){return!!o&&(s=!0,c=Date.now(),await async function(){b(),await new Promise((t=>setTimeout(t,150)));const t=await async function(t){for(let e=0;e<3;e++){{const n=document.querySelector(t);if(n)return n}await new Promise((t=>setTimeout(t,n)))}return null}(e.MAIN_MENU);if(!t)throw Error("Failed to find menu button");return t.click(),await new Promise((t=>setTimeout(t,200))),t}(),await async function(){const o=await async function(t){for(let e=0;e<3;e++){const e=f(t);if(e)return e;await new Promise((t=>setTimeout(t,n)))}return null}(t);if(!o)throw Error(t+" menu item not found");return o.querySelector(e.MENU_ITEM_CHECKED)||(o.click(),await new Promise((t=>setTimeout(t,n)))),!0}(),y(),!0)}(o)}catch(t){return y(),!1}}function v(){i=!0,p(),r||(r=()=>{a||(a=!0,setTimeout((async()=>{a=!1;const t=document.querySelector(e.PROFILE_DROPDOWN_MENU);!i||s||t||!await w()&&i&&await g(!0)}),500))},window.addEventListener("focus",r),document.addEventListener("visibilitychange",(()=>{document.hidden||!i||s||r()})))}function x(t){return`\n    <div class="toggle-switch" style="\n      position: relative;\n      width: 40px;\n      height: 20px;\n      background-color: ${t?"#1DB954":"#535353"};\n      border-radius: 10px;\n      transition: background-color 0.3s;\n    ">\n      <div class="toggle-slider" style="\n        position: absolute;\n        top: 2px;\n        left: ${t?"22px":"2px"};\n        width: 16px;\n        height: 16px;\n        background-color: white;\n        border-radius: 50%;\n        transition: left 0.3s;\n      "></div>\n    </div>\n  `}function h(n,e=0){const u=function(n,e){const o=Array.from(n.querySelectorAll("span")).find((n=>n.textContent===t));if(!o)return e<10&&setTimeout((()=>h(n,e+1)),100),null;const i=o.closest("li");return i||null}(n,e);if(!u)return null;const s=function(t){const n=document.createElement("li");n.id=o,n.className=t.className;const e=function(){const t=document.createElement("div");t.className="main-contextMenu-menuItemButton",t.style.cssText="display:flex;align-items:center;padding:8px 12px;cursor:pointer;justify-content:space-between;",t.setAttribute("role","menuitem");const n=document.createElement("span");n.textContent="Persistent Privacy";const e=function(){const t=document.createElement("span");return t.className="sidebar-checkbox",t.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",t.innerHTML=x(i),t.title=i?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode",t}();return t.appendChild(n),t.appendChild(e),function(t,n){t.addEventListener("mouseover",(n=>{n.stopPropagation(),t.style.backgroundColor="rgba(255,255,255,0.1)"})),t.addEventListener("mouseout",(n=>{n.stopPropagation(),t.style.backgroundColor="transparent"})),t.addEventListener("click",(t=>{t.stopPropagation(),i=!i,p(),i?v():(i=!1,p(),r&&(window.removeEventListener("focus",r),r=null)),n.innerHTML=x(i),n.title=i?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"}))}(t,e),t}();return n.appendChild(e),n}(u);return u.after(s),s}function T(n){if(!n)return;const r=function(t,n){const e=Array.from(t.querySelectorAll("span"));for(const t of e)if(t.textContent===n)return t.closest("button");return null}(n,t);if(!r)return;let u=n.querySelector("#"+o);u?function(t){const n=function(t){if(t)return t;const n=document.querySelector(e.PROFILE_DROPDOWN_MENU);return n?n.querySelector("#"+o):null}(t);if(!n)return;const r=n.querySelector("button");r&&function(t){const n=function(t){let n=t.querySelector(".sidebar-checkbox");return n||(n=document.createElement("span"),n.className="sidebar-checkbox",n.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",t.appendChild(n)),n}(t);n.innerHTML=x(i),n.title=i?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"}(r)}(u):u=h(n)}function E(t){const n=e.PROFILE_DROPDOWN_MENU.split(", ");for(const e of n){const n=t.matches&&t.matches(e.trim())?t:t.querySelector&&t.querySelector(e.trim());if(n)return n}return null}function k(t){return e.PROFILE_DROPDOWN_MENU.split(", ").some((n=>t.matches&&t.matches(n.trim())))}function M(t){for(const n of t)if(1===n.nodeType){const t=E(n);if(t)return{appeared:!0,menuList:t}}return{appeared:!1,menuList:null}}function P(t){for(const n of t)if(1===n.nodeType){const t=k(n),e=n.querySelector&&n.querySelector("#"+o);if(t||e)return!0}return!1}function _(n){const e=function(t){let n=!1,e=!1,o=null;for(const i of t){if(!u&&i.addedNodes){const t=M(i.addedNodes);if(t.appeared){n=!0,o=t.menuList;break}}if(u&&i.removedNodes&&P(i.removedNodes)){e=!0;break}}return{menuAppeared:n,menuDisappeared:e,detectedMenuList:o}}(n);!function({menuAppeared:n,menuDisappeared:e,detectedMenuList:o}){var i;e&&(u=!1),n&&o&&!u&&(function(n){const e=Array.from(n.querySelectorAll("span")).find((n=>n.textContent===t)),o=Array.from(n.querySelectorAll("span")).some((t=>"Settings"===t.textContent));return e||o}(i=o)&&Array.from(i.querySelectorAll("span")).find((n=>n.textContent===t))&&(T(i),u=!0,c=Date.now()))}(e)}(async t=>{for(;!t();)await new Promise((t=>setTimeout(t,n)));await async function(){!function(){const t=localStorage.getItem("private-session-persistent-mode");i="true"===t}(),new MutationObserver(_).observe(document.body,{childList:!0,subtree:!0}),await w(),i&&v(),await new Promise((t=>setTimeout(t,800))),await w()||await g(!0)}()})((()=>Spicetify&&Spicetify.Platform&&"complete"===document.readyState))})();